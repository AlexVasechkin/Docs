Модуль интеграции сайта на MODX Revolution и системы amoCRM

# Ключевые возможности:
* Из заказа на сайте создает сделку и контакт (или привязывает существующий)
* В свойствах заказа указывается метод оплаты и список товаров
* При смене статуса заказа изменяет статус сделки и наоборот
* Из любой формы обратной связи создает контакт
* Автоматически создает новую воронку для заказов с сайта и статусы заказов в ней
* Автоматически создает дополнительные поля сделок для списка товаров и метода оплаты
* Автоматически создает и обновляет Контакты при сохранении Пользователей на сайте
* Может создавать неограниченное количество дополнительных полей для контактов (упрощенный режим)

# Установка и настройка

## Системные настройки

| Название                       | Значение по умолчанию  | Описание                                                                            |
| ------------------------------ | ---------------------- | ----------------------------------------------------------------------------------- |
| **amocrm_account**             |                        | Аккаунт. Поддомен домена amocrm.ru                                                  |
| **amocrm_hash**                |                        | Ключ пользователя, можно получить на странице редактирования профиля пользователя   |
| **amocrm_login**               |                        | Логин, с которым вы авторизуетесь в amoCRM                                          |
| **amocrm_new_order_status_id** | 1                      | ID статуса нового заказа minishop2                                                  |
| **amocrm_pipeline_id**         |                        | ID воронки для нового заказа, заполняется автоматически при первом заказе           |
| **amocrm_secret_key**          |                        | Секретный ключ виджета                                                              |



## Как получить значение amocrm_secret_key

Ввод значения секретного ключа необходим только для создания дополнительных полей с помощью модуля. Если Вы планируете создавать поля самостоятельно, ключ вводить не требуется.

Перейдите в раздел API настроек **amoCRM** (*https://YOUR_DOMAIN.amocrm.ru/settings/dev/*) и добавьте новый виджет, если не создан ранее. 
В окне ввода кода виджета можно ввести что-то осмысленное, но самое главное, чтобы код оказался уникальным в рамках всего **amoCRM**.

Затем в таблице виджетов скопируйте значение из колонки *"Секретный ключ"* и введите в системну настройку.

## Настройка Webhook

Для получения изменений из amoCRM на сайт в блоке **Webhook** введите адрес `<http://stite.ru>/assets/components/amocrm/webhook.php`, заменив `<http://stite.ru>` на URL Вашего сайта.
После этого в выпадающем списке справа отметьте галочками события:
* Изменить сделку
* Смена статуса сделки

## Добавление дополнительных полей Контактам

При создании или изменении Контакта с сайта могут передаваться любые данные Пользователя. Единственное условие - должны быть созданы соответствующие дополнительные поля.
Если секретный ключ виджета указан, то новые поля можно создать прямо с сайта. Для этого удобнее всего использовать компонент **Console** и выполнить в нем следующий код:
```
if (!$amo = $modx->getService('amocrm', 'amoCRM', $modx->getOption('amocrm_core_path', null,
        $modx->getOption('core_path') . 'components/amocrm/') . 'model/amocrm/', array())
) {
    return 'Could not load amoCRM class!';
}
$amo->auth();
$amo->addContactsCustomFields(array('username', 'email', 'phone'));
```
Здесь видно, что перечень полей задается в виде стандартного массива PHP. Важно: поля должны совпадать со свойствами пользователей MODX.